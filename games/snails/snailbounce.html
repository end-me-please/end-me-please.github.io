    <HTML>
    <head>
        <title>Snails!</title>
        <script src="proceduralsnails.js"></script>
        <script src="proceduralfruit.js"></script>
        <script src="snailentity.js"></script>
        <script src="grid.js"></script>
    </head>
    <body>
        <input type="range" id="speed" min="1" max="10" value="1">Speed</range>
        <canvas id="canvas" width="800" height="600"></canvas>

    </body>
    <script>

        


        let canvas = document.getElementById("canvas");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        //remove margin and padding from the body
        document.body.style.margin = "0px";
        document.body.style.padding = "0px";
        //remove scrollbars
        document.body.style.overflow = "hidden";

        //move the speed slider on top of the canvas
        let speed = document.getElementById("speed");
        speed.style.position = "absolute";
        speed.style.top = "0px";
        speed.style.left = "0px";
        
        let trailCanvas = new OffscreenCanvas(canvas.width, canvas.height);
        let trailCtx = trailCanvas.getContext("2d");

        //clears the canvas
        let ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);


        let cursorX = 0;
        let cursorY = 0;
        let cursorDown = false;
        let debug = false;
        canvas.addEventListener("mousemove", function(event) {
            cursorX = event.clientX;
            cursorY = event.clientY;
        });
        canvas.addEventListener("mousedown", function(event) {
            cursorDown = true;

            //check position of cursor, if within a snail, add a crack
            for (let i = 0; i < snails.length; i++) {
                let dx = cursorX - snails[i].x;
                let dy = cursorY - snails[i].y;
                let distance = Math.sqrt(dx*dx + dy*dy);
                if (distance < snails[i].radius*2) {
                    snails[i].health--;
                }
            }

        });
        canvas.addEventListener("mouseup", function(event) {
            cursorDown = false;
        });

        let avgFrameTime = 5;
        


        





        let grid = new Grid(canvas.width, canvas.height, 8);

        let snails = [];        
        
        for (let i = 0; i < 1000; i++) {
            snails.push(new Snail());
            grid.addEntity(snails[i]);
        }
        

        function frame() {
            let t = Date.now();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            //put imagedata
            ctx.drawImage(trailCanvas, 0, 0);

            for (let i = 0; i < snails.length; i++) {
                snails[i].drawTrail(trailCtx);
            }

            //save
            ctx.save();
            for (let i = 0; i < snails.length; i++) {
                
                snails[i].render(ctx);
            
            }
            ctx.restore();
            

            
            for (let i = 0; i < Math.pow(speed.value,2); i++) {
                physicsFrame();
            }
            let frameTime = Date.now()-t;
            let newAvgFrameTime = (frameTime) * 0.05 + avgFrameTime * 0.95;
            avgFrameTime = newAvgFrameTime;
            window.requestAnimationFrame(frame);
            
        }

        let lastUpdated = false;
        function physicsFrame() {
            lastUpdated = !lastUpdated;
            if(lastUpdated) grid.updateGrid();
            if(debug==true) grid.debugRender(ctx);

            for (let i = 0; i < snails.length; i++) {
                snails[i].update();
                let potentialPartners = grid.getEntitiesInCircle(snails[i].x, snails[i].y, 9*snails[i].radius);
                //draw a line to each partner
                if(debug==true){
                for (let j = 0; j < potentialPartners.length; j++) {
                    ctx.beginPath();
                    ctx.moveTo(snails[i].x, snails[i].y);
                    ctx.lineTo(potentialPartners[j].x, potentialPartners[j].y);
                    ctx.strokeStyle = "red";
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
                }
                for (let j = 0; j < potentialPartners.length; j++) {
                    if (potentialPartners[j] != snails[i]) {
                        snails[i].collide(potentialPartners[j]);
                    }
                }
            }
        }






        setTimeout(function() {
            window.requestAnimationFrame(frame);
        }, 50);
        function randomColor() {
    let r = Math.floor(Math.random() * 255);
    let g = Math.floor(Math.random() * 255);
    let b = Math.floor(Math.random() *255);
    return "rgb(" + r + "," + g + "," + b + ")";
}
        













   </script>

</HTML>