<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gpu.js/1.0.2/gpu.min.js" integrity="sha512-cr2nuynSuSV6MGtWlympE0qd1g1TKBuEhv9lcfbW8HrE9UbPPc8zMwcje1fb9w2kzxqRnsizh6c+YbE6Ab7wpg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="./matrix.js"></script>
        <script src="./main.js"></script>
    </head>



    <body>
        <canvas id="canvas" width="800" height="800" style="border: 1px solid red; background-color: aliceblue;"></canvas>
        <canvas id="inspect" width="400" height="400" style="border: 1px solid black; background-color: aliceblue;"></canvas>
        <button id="extractOne" onclick="extractOne()">extract selected</button>
        <button id="importOne" onclick="importOne()">import single fish</button>
        <div>
            <label id="stats">Stats:</label>
        </div>
        <button id="mutate" onclick="sim.mutate(0.1)">Mutate</button>
        <button id="fastForward" onclick="fastForward(10)">fast forward 10 generations</button>
        
        </br>
        </br>
        <button id="save" onclick="saveAllWeights()">save all</button>
        <button id="load" onclick="loadAllWeights()">load all</button>

    </br>
    <button id="importClipboard" onclick="importClipboard()">import clipboard</button>
    <button id="exportClipboard" onclick="exportClipboard()">export clipboard</button>
    </body>




    <script>
    
        let autoUpdate = true;

        let generation = 0;
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let inspectCanvas = document.getElementById("inspect");
        let inspectCtx = inspectCanvas.getContext("2d");

        
        let sim = new Simulation(50);
        

        let inspectedFish = 0;
        sim.update();
        function loop(){
            try {
            sim.render(ctx);
            sim.fishes[inspectedFish].brain.draw(inspectCtx);
            //draw rectangle around observed fish
            ctx.strokeStyle = "red";
            ctx.beginPath();
            ctx.rect(sim.fishes[inspectedFish].x - sim.fishes[inspectedFish].size, sim.fishes[inspectedFish].y - sim.fishes[inspectedFish].size, sim.fishes[inspectedFish].size * 2, sim.fishes[inspectedFish].size * 2);
            ctx.stroke();
            //on the inspect canvas bottom right, print the fish's score
            inspectCtx.fillStyle = "black";
            inspectCtx.font = "15px Arial";
            inspectCtx.fillText("fitness: "+sim.fishes[inspectedFish].score, inspectCanvas.width*0.76, inspectCanvas.height*0.95);

            let highScore = 0;
            let lowScore = Infinity;
            let avgScore = 0;
            for (let i = 0; i < sim.fishes.length; i++) {
                avgScore += sim.fishes[i].score;
                if(sim.fishes[i].score > highScore) highScore = sim.fishes[i].score;
                if(sim.fishes[i].score < lowScore) lowScore = sim.fishes[i].score;
            }
            avgScore /= sim.fishes.length;
            
            //calculate mean score (not average)
            //sort and take middle value
            let sortedFishes = [...sim.fishes].sort((a,b) => a.score - b.score);
            let medianScore = sortedFishes[Math.floor(sortedFishes.length / 2)].score;
            //include generation number, round all numbers to 3 decimals
            //one per line
            document.getElementById("stats").innerHTML = "generation: "+generation+"</br>high score: "+highScore.toFixed(3)+"</br>low score: "+lowScore.toFixed(3)+"</br>average score: "+avgScore.toFixed(3)+"</br>median score: "+medianScore.toFixed(3);

        } catch (error) {
                console.log(error);
            }
            requestAnimationFrame(loop);
        }
        loop();
        let tick = 0;

        setInterval(() => {
            sim.update();
            tick++;
        }, 5);
    
        canvas.addEventListener("click", e => {
            let rect = canvas.getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;
            for (let i = 0; i < sim.fishes.length; i++) {
                let fish = sim.fishes[i];
                if(x > fish.x - fish.size && x < fish.x + fish.size && y > fish.y - fish.size && y < fish.y + fish.size) {
                    inspectedFish = i;
                    break;
                }
            }
        });

        function activation(x) {
            //return x;
            return Math.tanh(x);
        }


        function fastForward(generations) {
            autoUpdate = false;
            for (let i = 0; i < generations; i++) {
                let generationTicks = 2400;
                for (let j = 0; j < generationTicks; j++) {
                    sim.update();
                }
                sim.evolve();
                generation++;
            }
            autoUpdate = true;
        }









        function saveAllWeights() {
            let weights = [];
            for (let i = 0; i < sim.fishes.length; i++) {
                weights.push(sim.fishes[i].brain.weights);
            }
            localStorage.setItem("weights",JSON.stringify(weights));
            let biases = [];
            for (let i = 0; i < sim.fishes.length; i++) {
                biases.push(sim.fishes[i].brain.biases);
            }
            localStorage.setItem("biases",JSON.stringify(biases));
            
        }
        function loadAllWeights() {
            let weights = JSON.parse(localStorage.getItem("weights"));
            for (let i = 0; i < sim.fishes.length; i++) {
                sim.fishes[i].brain.weights = weights[i];
            }
            let biases = JSON.parse(localStorage.getItem("biases"));
            for (let i = 0; i < sim.fishes.length; i++) {
                sim.fishes[i].brain.biases = biases[i];
            }
        }

        function exportClipboard() {
            let weights = [];
            for (let i = 0; i < sim.fishes.length; i++) {
                weights.push(sim.fishes[i].brain.weights);
            }
            let biases = [];
            for (let i = 0; i < sim.fishes.length; i++) {
                biases.push(sim.fishes[i].brain.biases);
            }
            let data = {weights:weights,biases:biases};
            navigator.clipboard.writeText(JSON.stringify(data));
        }

        function importClipboard() {
            navigator.clipboard.readText().then(text => {
                let data = JSON.parse(text);
                for (let i = 0; i < sim.fishes.length; i++) {
                    sim.fishes[i].brain.weights = data.weights[i];
                }
                for (let i = 0; i < sim.fishes.length; i++) {
                    sim.fishes[i].brain.biases = data.biases[i];
                }
            });
        }

        function extractOne() {
            let weights = sim.fishes[inspectedFish].brain.weights;
            let biases = sim.fishes[inspectedFish].brain.biases;
            let data = {weights:weights,biases:biases};
            navigator.clipboard.writeText(JSON.stringify(data));
        }

        function importOne() {
            navigator.clipboard.readText().then(text => {
                let data = JSON.parse(text);
                sim.fishes[inspectedFish].brain.weights = data.weights;
                sim.fishes[inspectedFish].brain.biases = data.biases;
            });
        }




        setInterval(() => {
            if(autoUpdate&&tick>2000){
            generation++;
            sim.evolve();
            console.log("generation "+generation + " finished, ticks: "+tick);
            tick = 0;
            //sim.fishes[inspectedFish].brain = new ctrlBrain();
            }
        }, 15000);







    </script>
</html>